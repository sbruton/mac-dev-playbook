- name: Install Rust Toolchains
  vars:
    cargo_bin_path: "{{ ansible_env.HOME }}/.cargo/bin/cargo"
    rustup_bin_path: "{{ homebrew_brew_bin_path }}/rustup"
  block:
    - name: Check if cargo is installed
      vars:
        cargo_env_path: "{{ ansible_env.HOME }}/.cargo/bin:{{ ansible_env.PATH }}"
      environment:
        PATH: "{{ cargo_env_path }}"
      ansible.builtin.command: which cargo
      register: cargo_check
      ignore_errors: true
      changed_when: false

    - name: Initialize Rust
      ansible.builtin.command: "{{ homebrew_brew_bin_path }}/rustup-init -y"
      args:
        creates: "{{ cargo_bin_path }}"
      when: cargo_check.rc != 0
      changed_when: "cargo_check.rc != 0"

    - name: Check for rustup binary
      ansible.builtin.stat:
        path: "{{ rustup_bin_path }}"
      register: rustup_binary

    - name: List installed Rust toolchains
      ansible.builtin.command: "{{ rustup_bin_path }} toolchain list"
      register: rustup_toolchains
      changed_when: false
      when: rustup_binary.stat.exists

    - name: Install Stable Rust toolchain
      ansible.builtin.command: "{{ rustup_bin_path }} toolchain install stable"
      register: rustup_install_stable
      when: >-
        rustup_binary.stat.exists and
        (rustup_toolchains is defined) and
        ('stable' not in rustup_toolchains.stdout)
      changed_when: "'installed' in (rustup_install_stable.stdout | lower) or 'updating' in (rustup_install_stable.stdout | lower)"

    - name: Install Nightly Rust toolchain
      ansible.builtin.command: "{{ rustup_bin_path }} toolchain install nightly"
      register: rustup_install_nightly
      when: >-
        rustup_binary.stat.exists and
        (rustup_toolchains is defined) and
        ('nightly' not in rustup_toolchains.stdout)
      changed_when: "'installed' in (rustup_install_nightly.stdout | lower) or 'updating' in (rustup_install_nightly.stdout | lower)"

- name: Install Cargo Binaries
  vars:
    cargo_env_path: "{{ ansible_env.HOME }}/.cargo/bin:{{ ansible_env.PATH }}"
  environment:
    PATH: "{{ cargo_env_path }}"
  block:
    - name: List installed cargo packages
      ansible.builtin.command: cargo install --list
      register: cargo_install_list
      changed_when: false

    - name: Install cargo binary
      vars:
        cargo_package_name: "{{ (item.name | default(item)) if item is mapping else item }}"
        cargo_package_locked: "{{ (item.locked | default(false)) if item is mapping else false }}"
        cargo_package_pattern: "{{ '(?m)^' ~ cargo_package_name ~ ' v' }}"
      ansible.builtin.command: "cargo install{{ ' --locked' if cargo_package_locked else '' }} {{ cargo_package_name }}"
      loop: "{{ cargo_installed_binaries | default([]) }}"
      loop_control:
        label: "{{ cargo_package_name }}"
      when: not (cargo_install_list.stdout | regex_search(cargo_package_pattern))
      register: cargo_install_result
      changed_when: cargo_install_result.rc == 0

- name: Upgrade Cargo Binaries
  vars:
    cargo_env_path: "{{ ansible_env.HOME }}/.cargo/bin:{{ ansible_env.PATH }}"
  environment:
    PATH: "{{ cargo_env_path }}"
  block:
    - name: Upgrade Cargo Registry Binaries
      ansible.builtin.command: "cargo install-update -ai"
      register: cargo_upgrade_registry
      changed_when: "'upgraded' in ((cargo_upgrade_registry.stdout | default('')) | lower) or 'installed' in ((cargo_upgrade_registry.stdout | default('')) | lower)"

    - name: Upgrade Cargo GitHub Binaries
      ansible.builtin.command: "cargo install-update -aig"
      register: cargo_upgrade_github
      changed_when: "'upgraded' in ((cargo_upgrade_github.stdout | default('')) | lower) or 'installed' in ((cargo_upgrade_github.stdout | default('')) | lower)"
