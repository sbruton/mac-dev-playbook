---
- name: Configure default macOS settings
  tags: ["macos", "defaults"]
  vars:
    terminal_bundle_id: "{{ macos_terminal_bundle_id | default('com.googlecode.iterm2') }}"
    terminal_extension: "{{ macos_terminal_extension | default('command') }}"
  block:
    - name: Ensure duti is present in PATH
      ansible.builtin.command: which duti
      changed_when: false

    - name: Set default handler for extension {{ terminal_extension }}
      ansible.builtin.shell: |
        set -euo pipefail
        current="$(duti -x {{ terminal_extension | quote }} | awk 'NR==3 {print $0}' || true)"
        if [ "$current" = "{{ terminal_bundle_id | quote }}" ]; then
          echo "already-set"
          exit 0
        fi
        duti -s {{ terminal_bundle_id | quote }} {{ terminal_extension | quote }} all >/dev/null
        echo "updated-handler"
      args:
        executable: /bin/bash
      register: default_terminal_handler_result
      changed_when: "'updated-handler' in default_terminal_handler_result.stdout"
