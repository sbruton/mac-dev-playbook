# cspell:ignore controlcenter, duti, pipefail, googlecode, iterm

- name: Configure default macOS settings
  tags: ["macos", "defaults"]
  vars:
    terminal_bundle_id: "{{ macos_terminal_bundle_id | default('com.googlecode.iterm2') }}"
    terminal_extension: "{{ macos_terminal_extension | default('command') }}"
  block:
    - name: Ensure duti is present in PATH
      ansible.builtin.command: which duti
      changed_when: false

    - name: Set default handler for extension {{ terminal_extension }}
      ansible.builtin.shell: |
        set -euo pipefail
        current="$(duti -x {{ terminal_extension | quote }} | awk 'NR==3 {print $0}' || true)"
        if [ "$current" = "{{ terminal_bundle_id | quote }}" ]; then
          echo "already-set"
          exit 0
        fi
        duti -s {{ terminal_bundle_id | quote }} {{ terminal_extension | quote }} all >/dev/null
        echo "updated-handler"
      args:
        executable: /bin/bash
      register: default_terminal_handler_result
      changed_when: "'updated-handler' in default_terminal_handler_result.stdout"

    ## Doesn't work, needs further investigation
    # - name: Disable AirPlay receiver
    #   become: true
    #   ansible.builtin.shell: |
    #     set -euo pipefail
    #     current="$(/usr/bin/defaults read com.apple.controlcenter AirplayReceiverEnabled 2>/dev/null || echo 1)"
    #     if [ "$current" = "0" ]; then
    #       echo "airplay-disabled"
    #       exit 0
    #     fi
    #     /usr/bin/defaults write com.apple.controlcenter AirplayReceiverEnabled -bool false
    #     echo "airplay-updated"
    #   args:
    #     executable: /bin/bash
    #   register: airplay_receiver_result
    #   changed_when: "'airplay-updated' in airplay_receiver_result.stdout"

    - name: Enable 24-hour time format
      ansible.builtin.shell: |
        set -euo pipefail
        current="$(/usr/bin/defaults read NSGlobalDomain AppleICUForce24HourTime 2>/dev/null || echo 0)"
        if [ "$current" = "1" ]; then
          echo "time-format-set"
          exit 0
        fi
        /usr/bin/defaults write NSGlobalDomain AppleICUForce24HourTime -bool true
        echo "time-format-updated"
      args:
        executable: /bin/bash
      register: time_format_result
      changed_when: "'time-format-updated' in time_format_result.stdout"

    - name: Set measurement system to metric
      ansible.builtin.shell: |
        set -euo pipefail
        metric_flag="$(/usr/bin/defaults read NSGlobalDomain AppleMetricUnits 2>/dev/null || echo 0)"
        measurement="$(/usr/bin/defaults read NSGlobalDomain AppleMeasurementUnits 2>/dev/null || echo '')"
        if [ "$metric_flag" = "1" ] && [ "$measurement" = "Centimeters" ]; then
          echo "metric-already-set"
          exit 0
        fi
        /usr/bin/defaults write NSGlobalDomain AppleMetricUnits -bool true
        /usr/bin/defaults write NSGlobalDomain AppleMeasurementUnits -string "Centimeters"
        echo "metric-updated"
      args:
        executable: /bin/bash
      register: metric_system_result
      changed_when: "'metric-updated' in metric_system_result.stdout"

    - name: Set Monday as the first day of the week
      ansible.builtin.shell: |
        set -euo pipefail
        current="$({ /usr/bin/defaults read NSGlobalDomain AppleFirstWeekday 2>/dev/null; } || true)"
        if printf '%s\n' "$current" | /usr/bin/grep -F -q 'gregorian = 2;'; then
          echo "monday-already-set"
          exit 0
        fi
        /usr/bin/defaults write NSGlobalDomain AppleFirstWeekday -dict gregorian -int 2
        echo "monday-updated"
      args:
        executable: /bin/bash
      register: first_weekday_result
      changed_when: "'monday-updated' in first_weekday_result.stdout"

    - name: Enable dark appearance
      ansible.builtin.shell: |
        set -euo pipefail
        current_style="$(/usr/bin/defaults read NSGlobalDomain AppleInterfaceStyle 2>/dev/null || echo Light)"
        auto_mode="$(/usr/bin/defaults read NSGlobalDomain AppleInterfaceStyleSwitchesAutomatically 2>/dev/null || echo 0)"

        if [ "$current_style" = "Dark" ] && [ "$auto_mode" = "0" ]; then
          echo "dark-mode-already-set"
          exit 0
        fi

        /usr/bin/defaults write NSGlobalDomain AppleInterfaceStyle -string "Dark"
        /usr/bin/defaults write NSGlobalDomain AppleInterfaceStyleSwitchesAutomatically -bool false
        echo "dark-mode-updated"
      args:
        executable: /bin/bash
      register: dark_mode_result
      changed_when: "'dark-mode-updated' in dark_mode_result.stdout"

    - name: Enforce ISO-style date format (YYYY-MM-DD)
      ansible.builtin.shell: |
        set -euo pipefail
        target="y-MM-dd"
        plist="$HOME/Library/Preferences/.GlobalPreferences.plist"

        if [ ! -f "$plist" ]; then
          /usr/bin/defaults write NSGlobalDomain TempGlobalPreferencesInit -bool true >/dev/null
          /usr/bin/defaults delete NSGlobalDomain TempGlobalPreferencesInit >/dev/null 2>&1 || true
        fi

        changed=0

        if ! /usr/libexec/PlistBuddy -c "Print :AppleICUDateFormatStrings" "$plist" >/dev/null 2>&1; then
          /usr/libexec/PlistBuddy -c "Add :AppleICUDateFormatStrings dict" "$plist" >/dev/null
          changed=1
        fi

        current="$(/usr/libexec/PlistBuddy -c "Print :AppleICUDateFormatStrings:1" "$plist" 2>/dev/null || true)"
        if [ "$current" != "$target" ]; then
          if ! /usr/libexec/PlistBuddy -c "Set :AppleICUDateFormatStrings:1 $target" "$plist" >/dev/null 2>&1; then
            /usr/libexec/PlistBuddy -c "Add :AppleICUDateFormatStrings:1 string $target" "$plist" >/dev/null
          fi
          changed=1
        fi

        for extra_key in 2 3 4; do
          if /usr/libexec/PlistBuddy -c "Print :AppleICUDateFormatStrings:$extra_key" "$plist" >/dev/null 2>&1; then
            /usr/libexec/PlistBuddy -c "Delete :AppleICUDateFormatStrings:$extra_key" "$plist" >/dev/null
            changed=1
          fi
        done

        if /usr/libexec/PlistBuddy -c "Print :AppleICUNumericDateFormatStrings" "$plist" >/dev/null 2>&1; then
          /usr/libexec/PlistBuddy -c "Delete :AppleICUNumericDateFormatStrings" "$plist" >/dev/null
          changed=1
        fi

        if [ "$changed" -eq 0 ]; then
          echo "date-format-already-set"
        else
          echo "date-format-updated"
        fi
      args:
        executable: /bin/bash
      register: date_format_result
      changed_when: "'date-format-updated' in date_format_result.stdout"
